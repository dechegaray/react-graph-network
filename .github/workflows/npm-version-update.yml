name: NPM Version Bump

on:
  push:
    branches:
      - master
  pull_request:
    types:
      - closed
    branches:
      - 'master'

#const isMerged = pr.merged === true;

jobs:
  npm_version_bump:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR labels
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const childProcess = require('child_process');
            const pr = context.payload.pull_request;
            const isMerged = true;
            const hasLabels = pr.labels.length > 0;

            if (isMerged && hasLabels) {
              console.log('PR was merged and has labels');
              const supportedLabels = ['minor', 'patch', 'major'];
              
              const labels = pr.labels.map((label) => label.name);
              const versionLabel = labels.find((label) => supportedLabels.includes(label));

              if (!!versionLabel) {
                console.log('PR has version label');
                const cmd = `npm version ${versionLabel}`;
                console.log('Running command:', cmd);

                childProcess.execSync(cmd, { stdio: 'inherit' });

                console.log('Package version bumped');
              } else {
                console.log('PR does not have version label. Skipping version update');
              }
            } else {
              console.log('PR was not merged or does not have labels. Skipping version update');
            }
